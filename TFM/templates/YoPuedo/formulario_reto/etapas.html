<!-- BOTONES NAVEGACIÓN TABS -->
<ul class="nav nav-tabs" id="tab-etapas" role="tablist">
  {% for etapa_form in etapas_form %}
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if forloop.counter == 1 %} active {% endif %}"
            id="etapa-{{ forloop.counter }}-tab" data-bs-toggle="tab"
            data-bs-target="#etapa-{{ forloop.counter }}" type="button" role="tab"
            aria-controls="etapa-{{ forloop.counter }}" aria-selected="true"
            onclick="cambiarPestanaEtapa('etapa-{{ forloop.counter }}')">
      <div class="row">
        <div class="col-2">
          <i class="fa-solid fa-chart-simple"></i>
        </div>
        <div class="d-none d-md-block col-9">
          <h5>{{ forloop.counter }}º Etapa</h5>
        </div>
      </div>
    </button>
  </li>
  {% endfor %}
</ul>

<!-- CUERPO DE LOS TABS -->
<div class="tab-content p-3" id="form-etapa-content">
  {{ etapas_form.management_form }}
  {% for etapa_form in etapas_form %}
  <div class="tab-pane fade {% if forloop.counter == 1 %} show active {% endif %}"
       id="etapa-{{ forloop.counter }}" role="tabpanel"
       aria-labelledby="etapa-{{ forloop.counter }}-tab">
    {% include 'YoPuedo/formulario_reto/etapa.html' with num_etapa=forloop.counter %}
  </div>
  {% endfor %}
</div>

<div class="row">
  <div class='form-group d-flex justify-content-start mt-5 col'>
      <button type="button" id="boton-anterior" class="btn btn-primary fw-bold"
              onclick="cambiarPestana('general')">
          <i class="fa-solid fa-angle-left"></i>
          Anterior
      </button>
  </div>

  <div class='form-group d-flex justify-content-end mt-5 col'>
      <button type="button" id="boton-siguiente" class="btn btn-primary fw-bold"
              onclick="{% if tipo_reto == 'colectivo'%} cambiarPestana('participantes') {% else %} cambiarPestana('animadores') {% endif %}">
          Siguiente
          <i class="fa-solid fa-angle-right"></i>
      </button>
  </div>
</div>

<script>

  function cambiarPestanaEtapa(id){
    $('#tab-etapas button[aria-controls="' + id + '"]').tab('show');
    cambiarColorCuerpo(id);
  }

  function getNumEtapa(etapa, cantidad){
    num_etapa = etapa + cantidad;

    if (num_etapa > {{ etapas_form.total_form_count }})
        crearEtapa(num_etapa);

    return 'etapa-' + num_etapa;
  }

  function crearEtapa(num_etapa){

    // Clonamos la última pestaña
    const pestana = document.getElementById("tab-etapas").lastChild;
    const clone = pestana.cloneNode(true);

    // Cambiamos los valores a la nueva etapa
    button = clone.getElementById(pestana.id);
    button.classList.remove("active");
    button.id = "etapa-" + num_etapa + "-tab";
    button.attr('data-bs-target', "#etapa-" + num_etapa);
    button.attr('aria-controls', "etapa-" + num_etapa);
    button.attr('onclick', "cambiarPestanaEtapa('etapa-" + num_etapa + "')");
    titulo = button.getElementsByTagName("h5")[0];
    titulo.innerText = num_etapa + "º Etapa";

    // Insertamos la última pestaña
    pestana.parentNode.appendChild(clone);

    // Añadimos la etapa en la variable TOTAL_FORMS
    $('#id_form-TOTAL_FORMS').val(num_etapa);
  }


</script>